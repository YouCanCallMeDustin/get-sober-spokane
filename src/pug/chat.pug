extends layout

block head
  title Live Chat Room - Get Sober Spokane
  meta(name="description" content="Join our live recovery support chat room. Connect with the community in real-time, share your journey, and find immediate support.")
  meta(name="keywords" content="recovery chat, sobriety support chat, live recovery support, Spokane recovery chat, sober community chat")
  link(rel="stylesheet" href="/css/styles.css?v=" + timestamp + "&r=" + random)

block content
  // Chat Room Container with proper spacing for fixed navigation
  .chat-container
    // Hero Banner Section
    .chat-hero
      .container
        .row.justify-content-center.text-center
          .col-lg-10.col-md-12
            h1.chat-hero-title Live Chat Room
            p.chat-hero-subtitle Connect with the recovery community in real-time. Share your journey and find immediate support.
            .chat-status
              span.status-indicator#connectionStatus
                i.bi.bi-circle-fill.me-2
                | Connecting...
            if user && !user.isAnonymous
              .user-welcome
                p Welcome back, #{user.display_name || user.username || 'User'}!
            else
              .user-welcome
                p You're chatting as Anonymous. #[a(href="/login" class="sign-in-link") Sign in] to use your username.
    
    // Main Chat Content
    .chat-content
      .container
        .row.justify-content-center
          // Chat Sidebar
          .col-lg-3.col-md-4.d-none.d-md-block
            .chat-sidebar
              // Online Users
              .sidebar-section
                h5.sidebar-title
                  i.bi.bi-people-fill.me-2
                  | Online Now
                .online-users#onlineUsers
                  .loading-users
                    i.bi.bi-arrow-clockwise.spin
                    | Loading users...
              
              // Chat Rooms
              .sidebar-section
                h5.sidebar-title
                  i.bi.bi-hash.me-2
                  | Chat Rooms
                .chat-rooms
                  .room-item.active#generalRoom(data-room="general")
                    i.bi.bi-hash.me-2
                    span.room-name General Support
                    span.room-count 0
                  .room-item#recoveryRoom(data-room="recovery")
                    i.bi.bi-hash.me-2
                    span.room-name Recovery Journey
                    span.room-count 0
                  .room-item#crisisRoom(data-room="crisis")
                    i.bi.bi-hash.me-2
                    span.room-name Crisis Support
                    span.room-count 0
                  .room-item#celebrationsRoom(data-room="celebrations")
                    i.bi.bi-hash.me-2
                    span.room-name Celebrations
                    span.room-count 0
              
              // Quick Actions
              .sidebar-section
                h5.sidebar-title
                  i.bi.bi-lightning-fill.me-2
                  | Quick Actions
                .quick-actions
                  button.btn.btn-outline-primary.btn-sm.w-100.mb-2#shareResourceBtn
                    i.bi.bi-share.me-2
                    | Share Resource
                  button.btn.btn-outline-success.btn-sm.w-100.mb-2#requestSupportBtn
                    i.bi.bi-heart.me-2
                    | Request Support
                  button.btn.btn-outline-warning.btn-sm.w-100#reportIssueBtn
                    i.bi.bi-flag.me-2
                    | Report Issue
          
          // Main Chat Area
          .col-lg-8.col-md-8.col-12
            .chat-main
              // Chat Header
              .chat-header
                .chat-room-info
                  h4#currentRoomName General Support
                  p#roomDescription General recovery support and community discussion
                  .room-status
                    span.status-dot.active
                    | Active
              
              // Messages Container
              .messages-container#messagesContainer
                .welcome-message
                  .message-bubble.system
                    .message-content
                      h6 Welcome to the Recovery Support Chat!
                      p This is a safe space for sharing, supporting, and connecting with others on their recovery journey.
                      .message-header
                        span.message-sender System
                        span.message-time Just now
                
                // Messages will be loaded dynamically here
              
              // Message Input Area
              .message-input-area
                .input-container
                  .input-group
                    button.btn.btn-outline-secondary#emojiPicker(type="button")
                      i.bi.bi-emoji-smile
                    input.form-control#messageInput(type="text" placeholder="Type your message here..." maxlength="500" disabled)
                    button.btn.btn-outline-secondary#attachFile(type="button" disabled)
                      i.bi.bi-paperclip
                    button.btn.btn-primary#sendMessage(type="button" disabled)
                      i.bi.bi-send
                  
                  .input-actions
                    .typing-indicator#typingIndicator(style="display: none;")
                      i.bi.bi-three-dots
                      span Someone is typing...
                    .character-count
                      span#charCount 0
                      | /500
                
                // File Upload Progress
                .file-upload-progress#fileUploadProgress(style="display: none;")
                  .progress
                    .progress-bar#uploadProgressBar(role="progressbar" style="width: 0%")
                  .upload-info
                    span#uploadFileName
                    button.btn.btn-sm.btn-outline-danger#cancelUpload
                      i.bi.bi-x

    // Chat Settings Modal
    .modal.fade#chatSettingsModal(tabindex="-1")
      .modal-dialog
        .modal-content
          .modal-header
            h5.modal-title Chat Settings
            button.btn-close(type="button" data-bs-dismiss="modal")
          .modal-body
            .form-group.mb-3
              label(for="usernameInput" class="form-label") Display Name
              input(type="text" class="form-control" id="usernameInput" placeholder="Enter your display name" value=user && !user.isAnonymous ? user.display_name || user.username : '')
            .form-group.mb-3
              label(for="notificationToggle" class="form-label") Notifications
              .form-check.form-switch
                input.form-check-input(type="checkbox" id="notificationToggle" checked)
                label.form-check-label(for="notificationToggle") Enable sound notifications
            .form-group.mb-3
              label(for="themeToggle" class="form-label") Theme
              select.form-select#themeToggle
                option(value="light") Light Theme
                option(value="dark") Dark Theme
                option(value="auto") Auto (System)
          .modal-footer
            button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
            button.btn.btn-primary#saveSettings(type="button") Save Settings

    // Emoji Picker Modal
    .emoji-picker#emojiPickerModal(style="display: none;")
      .emoji-picker-content
        .emoji-picker-header
          h6 Emoji Reactions
          button.btn-close#closeEmojiPicker
        .emoji-picker-body
          .emoji-categories
            button.emoji-category.active(data-category="smileys") ðŸ˜Š
            button.emoji-category(data-category="animals") ðŸ¾
            button.emoji-category(data-category="food") ðŸŽ
            button.emoji-category(data-category="activities") âš½
            button.emoji-category(data-category="objects") ðŸ’¡
            button.emoji-category(data-category="symbols") â¤ï¸
          .emoji-grid#emojiGrid
            // Emojis will be populated dynamically

    // File Preview Modal
    .modal.fade#filePreviewModal(tabindex="-1")
      .modal-dialog.modal-lg
        .modal-content
          .modal-header
            h5.modal-title#filePreviewTitle File Preview
            button.btn-close(type="button" data-bs-dismiss="modal")
          .modal-body
            .file-preview-content#filePreviewContent
              // File preview will be shown here
          .modal-footer
            button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Close
            button.btn.btn-primary#downloadFile(type="button") Download

block scripts
  script(src="/socket.io/socket.io.js")
  script(src="/js/chat.js?v=" + timestamp + "&r=" + random)
  
  // Prevent any other chat scripts from loading
  script.
    // Block any attempts to load the old chat-room.js
    const originalCreateElement = document.createElement;
    document.createElement = function(tagName) {
      const element = originalCreateElement.call(document, tagName);
      if (tagName.toLowerCase() === 'script') {
        const originalSetAttribute = element.setAttribute;
        element.setAttribute = function(name, value) {
          if (name === 'src' && value && value.includes('chat-room.js')) {
            console.log('ðŸš« Blocked attempt to load old chat-room.js:', value);
            return element;
          }
          return originalSetAttribute.call(this, name, value);
        };
      }
      return element;
    };
    
    // Also block any script tags that might be added dynamically
    const originalAppendChild = Node.prototype.appendChild;
    Node.prototype.appendChild = function(child) {
      if (child.tagName === 'SCRIPT' && child.src && child.src.includes('chat-room.js')) {
        console.log('ðŸš« Blocked dynamic loading of old chat-room.js:', child.src);
        return child;
      }
      return originalAppendChild.call(this, child);
    };
  
  // Pass user data to JavaScript
  script.
    window.currentUser = !{JSON.stringify(user || {})};
    window.timestamp = '#{timestamp}';
    window.random = '#{random}';
  
  // Additional cache busting for development
  script.
    // Force refresh of CSS and JS files if they're cached
    (function() {
      const timestamp = '#{timestamp}';
      const random = '#{random}';
      const currentTime = Date.now();
      
      console.log('ðŸ”„ Starting enhanced cache busting...');
      
      // Force refresh CSS with multiple cache busters
      const links = document.querySelectorAll('link[href*="styles.css"]');
      links.forEach(link => {
        if (link.href.includes('styles.css')) {
          link.href = link.href.split('?')[0] + '?v=' + timestamp + '&r=' + random + '&t=' + currentTime + '&cb=' + Math.random();
        }
      });
      
      // Force refresh JS with multiple cache busters
      const scripts = document.querySelectorAll('script[src*="chat.js"]');
      scripts.forEach(script => {
        if (script.src.includes('chat.js')) {
          script.src = script.src.split('?')[0] + '?v=' + timestamp + '&r=' + random + '&t=' + currentTime + '&cb=' + Math.random();
        }
      });
      
      // Clear any cached images
      const images = document.querySelectorAll('img');
      images.forEach(img => {
        if (img.src && !img.src.includes('data:')) {
          img.src = img.src.split('?')[0] + '?v=' + timestamp + '&r=' + random + '&t=' + currentTime + '&cb=' + Math.random();
        }
      });
      
      console.log('ðŸ”„ Enhanced cache busting applied:', { timestamp, random, currentTime });
      
      // Force a complete page reload if cache is still an issue
      if (window.performance && window.performance.navigation.type === window.performance.navigation.TYPE_BACK_FORWARD) {
        console.log('ðŸ”„ Back/forward navigation detected, forcing reload');
        window.location.reload(true);
      }
      
      // Monitor for style changes and DOM modifications
      let styleCheckInterval;
      let mutationObserver;
      
      function checkStyles() {
        const roomItems = document.querySelectorAll('.room-item');
        const messageBubbles = document.querySelectorAll('.message-bubble');
        const chatHeader = document.querySelector('.chat-header');
        const chatHero = document.querySelector('.chat-hero');
        
        console.log('ðŸ” Checking styles...', {
          roomItemsCount: roomItems.length,
          messageBubblesCount: messageBubbles.length,
          chatHeaderExists: !!chatHeader,
          chatHeroExists: !!chatHero
        });
        
        // Check if styles are being overridden
        roomItems.forEach((item, index) => {
          const computedStyle = window.getComputedStyle(item);
          const padding = computedStyle.padding;
          const borderRadius = computedStyle.borderRadius;
          const border = computedStyle.border;
          const background = computedStyle.background;
          
          console.log(`Room item ${index} styles:`, { padding, borderRadius, border, background });
          
          // If styles are wrong, force them
          if (padding !== '14px 16px' && borderRadius !== '10px') {
            console.log(`ðŸ”„ Forcing styles for room item ${index}`);
            item.style.setProperty('padding', '0.875rem 1rem', 'important');
            item.style.setProperty('border-radius', '10px', 'important');
            item.style.setProperty('border', '2px solid rgba(0, 123, 255, 0.1)', 'important');
            item.style.setProperty('font-weight', '500', 'important');
            item.style.setProperty('font-size', '0.95rem', 'important');
          }
          
          // Check for active state
          if (item.classList.contains('active')) {
            if (!background.includes('linear-gradient')) {
              console.log(`ðŸ”„ Forcing active styles for room item ${index}`);
              item.style.setProperty('background', 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)', 'important');
              item.style.setProperty('color', 'white', 'important');
              item.style.setProperty('border-color', '#007bff', 'important');
              item.style.setProperty('box-shadow', '0 6px 20px rgba(0, 123, 255, 0.4)', 'important');
            }
          }
        });
        
        messageBubbles.forEach((bubble, index) => {
          const computedStyle = window.getComputedStyle(bubble);
          const borderRadius = computedStyle.borderRadius;
          const padding = computedStyle.padding;
          
          console.log(`Message bubble ${index} styles:`, { borderRadius, padding });
          
          if (borderRadius !== '16px' && padding !== '20px') {
            console.log(`ðŸ”„ Forcing styles for message bubble ${index}`);
            bubble.style.setProperty('border-radius', '16px', 'important');
            bubble.style.setProperty('padding', '1.25rem', 'important');
            bubble.style.setProperty('margin-bottom', '1.25rem', 'important');
            bubble.style.setProperty('box-shadow', '0 4px 20px rgba(0, 0, 0, 0.08)', 'important');
            bubble.style.setProperty('max-width', '85%', 'important');
          }
        });
        
        if (chatHeader) {
          const computedStyle = window.getComputedStyle(chatHeader);
          const background = computedStyle.background;
          
          console.log('Chat header background:', background);
          
          if (!background.includes('linear-gradient')) {
            console.log('ðŸ”„ Forcing chat header styles');
            chatHeader.style.setProperty('background', 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)', 'important');
            chatHeader.style.setProperty('padding', '2rem 1.5rem', 'important');
            chatHeader.style.setProperty('border-radius', '12px 12px 0 0', 'important');
            chatHeader.style.setProperty('color', 'white', 'important');
          }
        }
        
        if (chatHero) {
          const computedStyle = window.getComputedStyle(chatHero);
          const background = computedStyle.background;
          
          console.log('Chat hero background:', background);
          
          if (!background.includes('linear-gradient')) {
            console.log('ðŸ”„ Forcing chat hero styles');
            chatHero.style.setProperty('background', 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)', 'important');
            chatHero.style.setProperty('color', 'white', 'important');
            chatHero.style.setProperty('padding', '3rem 0', 'important');
            chatHero.style.setProperty('margin-bottom', '2rem', 'important');
            chatHero.style.setProperty('box-shadow', '0 4px 20px rgba(0, 123, 255, 0.3)', 'important');
          }
        }
      }
      
      // Monitor DOM changes
      function setupMutationObserver() {
        const targetNode = document.body;
        const config = { 
          childList: true, 
          subtree: true, 
          attributes: true, 
          attributeFilter: ['class', 'style'] 
        };
        
        const callback = function(mutationsList, observer) {
          for (const mutation of mutationsList) {
            if (mutation.type === 'attributes') {
              console.log('ðŸ” DOM attribute changed:', {
                target: mutation.target.tagName,
                attributeName: mutation.attributeName,
                oldValue: mutation.oldValue,
                newValue: mutation.target.getAttribute(mutation.attributeName)
              });
              
              // If styles or classes are being modified, check and fix
              if (mutation.attributeName === 'style' || mutation.attributeName === 'class') {
                setTimeout(checkStyles, 100);
              }
            }
          }
        };
        
        mutationObserver = new MutationObserver(callback);
        mutationObserver.observe(targetNode, config);
        console.log('ðŸ” Mutation observer started');
      }
      
      // Force apply styles after a short delay to ensure they take precedence
      setTimeout(() => {
        console.log('ðŸ”„ Forcing style application...');
        
        // Force room items to have correct styling
        const roomItems = document.querySelectorAll('.room-item');
        roomItems.forEach(item => {
          item.style.setProperty('padding', '0.875rem 1rem', 'important');
          item.style.setProperty('border-radius', '10px', 'important');
          item.style.setProperty('border', '2px solid rgba(0, 123, 255, 0.1)', 'important');
          item.style.setProperty('font-weight', '500', 'important');
          item.style.setProperty('font-size', '0.95rem', 'important');
        });
        
        // Force message bubbles to have correct styling
        const messageBubbles = document.querySelectorAll('.message-bubble');
        messageBubbles.forEach(bubble => {
          bubble.style.setProperty('border-radius', '16px', 'important');
          bubble.style.setProperty('padding', '1.25rem', 'important');
          bubble.style.setProperty('margin-bottom', '1.25rem', 'important');
          bubble.style.setProperty('box-shadow', '0 4px 20px rgba(0, 0, 0, 0.08)', 'important');
          bubble.style.setProperty('max-width', '85%', 'important');
        });
        
        // Force chat header styling
        const chatHeader = document.querySelector('.chat-header');
        if (chatHeader) {
          chatHeader.style.setProperty('background', 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)', 'important');
          chatHeader.style.setProperty('padding', '2rem 1.5rem', 'important');
          chatHeader.style.setProperty('border-radius', '12px 12px 0 0', 'important');
          chatHeader.style.setProperty('color', 'white', 'important');
        }
        
        // Force chat hero styling
        const chatHero = document.querySelector('.chat-hero');
        if (chatHero) {
          chatHero.style.setProperty('background', 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)', 'important');
          chatHero.style.setProperty('color', 'white', 'important');
          chatHero.style.setProperty('padding', '3rem 0', 'important');
          chatHero.style.setProperty('margin-bottom', '2rem', 'important');
          chatHero.style.setProperty('box-shadow', '0 4px 20px rgba(0, 123, 255, 0.3)', 'important');
        }
        
        console.log('âœ… Styles forced applied');
        
        // Start monitoring for style changes
        styleCheckInterval = setInterval(checkStyles, 500); // Check every 500ms
        setupMutationObserver();
        
        // Stop monitoring after 60 seconds
        setTimeout(() => {
          if (styleCheckInterval) {
            clearInterval(styleCheckInterval);
            console.log('ðŸ›‘ Style monitoring stopped');
          }
          if (mutationObserver) {
            mutationObserver.disconnect();
            console.log('ðŸ›‘ Mutation observer stopped');
          }
        }, 60000);
      }, 100);
    })();
