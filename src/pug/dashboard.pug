extends layout

block content
  // Dashboard Container with proper spacing for fixed navigation
  .dashboard-container
    // Hero Banner Section
    .dashboard-hero
      .container
        .row.justify-content-center.text-center
          .col-lg-8
            h1.dashboard-hero-title Welcome, #{user ? user.displayName : 'Get Sober Spokane'}!
            p.dashboard-hero-subtitle Manage your recovery journey and access resources
    
    // Main Dashboard Content
    .dashboard-content
      .container
        // Sign In Form (shown when not authenticated)
        #signInForm.dashboard-card.auth-card(style="display: none;")
          .row.justify-content-center
            .col-lg-6
              h3.card-title.text-center Sign In to Your Dashboard
              p.text-center.text-muted Access your recovery progress and manage your journey
              
              // Google Sign In Button
              .mb-3
                button.btn.btn-outline-dark.w-100#googleSignInBtn(type="button")
                  i.bi.bi-google.me-2
                  | Sign in with Google
              
              .text-center.mb-3
                span.text-muted OR
              
              form#loginForm
                .mb-3
                  label.form-label(for="email") Email Address
                  input.form-control#email(type="email" name="email" required)
                .mb-3
                  label.form-label(for="password") Password
                  input.form-control#password(type="password" name="password" required)
                .mb-3
                  button.btn.btn-primary.w-100#signInBtn(type="submit") Sign In
                  button.btn.btn-outline-secondary.w-100.mt-2#signUpBtn(type="button") Create Account
                
                .text-center.mt-3
                  a.text-muted(href="#" id="forgotPassword") Forgot your password?
        
        // Dashboard Content (shown when authenticated)
        #dashboardContent(style="display: none;")
          .row
            // Left Column - Recovery Progress
            .col-lg-8.mb-4
              .dashboard-card.recovery-card
                h3.card-title Recovery Progress
                
                // Interactive Progress Visualization
                .progress-visualization
                  .row
                    .col-md-6
                      // Sobriety Progress Ring
                      .progress-ring-container
                        h5.section-label Sobriety Progress
                        .progress-ring-wrapper
                          canvas#sobrietyProgressRing(width="200" height="200")
                          .progress-ring-overlay
                            .progress-text
                              span.progress-number#progressRingDays 0
                              span.progress-label days
                            .progress-subtitle Sober & Strong
                      
                      // Achievement Badges
                      .achievement-badges
                        h5.section-label Recent Achievements
                        .badges-grid#achievementBadges
                          // Badges will be populated dynamically
                    
                    .col-md-6
                      // Sobriety Counter Section
                      .sobriety-section
                        h5.section-label Sobriety Counter
                        .sobriety-counter
                          .counter-display
                            span.counter-number#sobrietyDays 0
                            span.counter-label days
                          p.counter-subtitle Since your last drink or drug use
                        
                        // Sobriety Date Update
                        .sobriety-date-update
                          label(for="sobrietyDate") Update Sobriety Date:
                          .date-input-group
                            input.form-control#sobrietyDate(type="date" name="sobrietyDate")
                            button.btn.btn-primary#updateSobrietyDate Update
                  
                  // Progress Timeline
                  .progress-timeline
                    h5.section-label Recovery Journey
                    .timeline-container#progressTimeline
                      // Timeline will be populated dynamically
                
                // Recovery Milestones Section
                .milestones-section
                  h5.section-label Recovery Milestones
                  .milestones-list#milestonesList
                    // Milestones will be loaded dynamically
                  .add-milestone
                    button.btn.btn-success#addMilestoneBtn(type="button") + Add Milestone
            
            // Right Column - Community Connections and Quick Actions
            .col-lg-4.mb-4
              // Community Connections
              .dashboard-card.connections-card
                h3.card-title Community Connections
                .connections-section
                  h5.section-label My Connections
                  .connections-list#connectionsList
                    // Connections will be loaded dynamically
                    .connection-item.placeholder(style="display: none;")
                      .connection-avatar
                        i.bi.bi-person-circle
                      .connection-info
                        .connection-name Loading...
                        .connection-status Loading connections...
                      .connection-actions
                        button.btn.btn-sm.btn-outline-primary(disabled) Loading
                  .no-connections.text-center.py-4(style="display: none;")
                    i.bi.bi-people.text-muted(style="font-size: 2rem;")
                    p.text-muted.mt-2 No connections yet
                    p.small.text-muted Connect with sponsors and recovery friends
                  button.btn.btn-success.btn-sm.w-100.mt-2#addConnectionBtn
                    i.bi.bi-person-plus
                    |  Find Sponsor
                .challenges-section
                  h5.section-label Active Challenges
                  .challenges-list#challengesList
                    .challenge-item
                      .challenge-header
                        h6 30-Day Sobriety Challenge
                        span.challenge-participants 24 participants
                      .challenge-progress
                        .progress
                          .progress-bar(style="width: 65%")
                        span.progress-text 19/30 days
                      .challenge-actions
                        button.btn.btn-sm.btn-outline-success View Details
                  button.btn.btn-outline-primary.btn-sm.w-100.mt-2#joinChallengeBtn
                    i.bi.bi-trophy
                    |  Join Challenge

              // Quick Actions
              .dashboard-card.quick-actions-card.mt-3
                h3.card-title Quick Actions
                .quick-actions-list
                  a.quick-action-btn.emergency-btn(href="/resource-directory.html#emergency-help")
                    .action-icon
                      i.bi.bi-exclamation-triangle
                    .action-text Emergency Help
                  a.quick-action-btn(href="/resource-directory.html")
                    .action-icon
                      i.bi.bi-search
                    .action-text Resource Directory
                  a.quick-action-btn(href="/community-forum.html")
                    .action-icon
                      i.bi.bi-people
                    .action-text Community Forum
                  a.quick-action-btn(href="/chat")
                    .action-icon
                      i.bi.bi-chat-dots
                    .action-text Live Chat
                  a.quick-action-btn(href="/sponsor-finder.html")
                    .action-icon
                      i.bi.bi-person-heart
                    .action-text Find Sponsor
                  a.quick-action-btn#viewProfileLink(href="#" style="display: none;")
                    .action-icon
                      i.bi.bi-person
                    .action-text View Profile
                  a.quick-action-btn(href="/donations.html")
                    .action-icon
                      i.bi.bi-heart
                    .action-text Support Our Mission
                a.btn.btn-outline-success.btn-sm.w-100.mt-2(href="/community-engagement-sober-activities.html") View All Events

block scripts
  script(src="https://cdn.jsdelivr.net/npm/chart.js")
  script.
    // Dashboard functionality with Supabase integration
    let supabase;
    let currentUser = null;
    let sobrietyProgressChart = null;
    
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', async function() {
      await initializeSupabase();
      await initializeDashboard();
      setupEventListeners();
    });
    
    async function initializeSupabase() {
      try {
        // Get Supabase credentials from config
        const supabaseUrl = window.APP_CONFIG?.SUPABASE_URL || '';
        const supabaseKey = window.APP_CONFIG?.SUPABASE_ANON_KEY || '';
        
        if (!supabaseUrl || !supabaseKey) {
          console.error('Supabase credentials not found');
          return;
        }
        
        // Create Supabase client
        supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        console.log('Supabase client initialized');
        
        // Check authentication state
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
          currentUser = session.user;
          updateUserDisplay();
          // Update profile link
          const profileLink = document.getElementById('viewProfileLink');
          if (profileLink) {
            profileLink.href = `/user-profile.html?id=${currentUser.id}`;
            profileLink.style.display = 'flex';
          }
        }
      } catch (error) {
        console.error('Failed to initialize Supabase:', error);
      }
    }
    
    async function initializeDashboard() {
      try {
        if (!supabase) return;
        
        // Check if user is authenticated
        if (currentUser) {
          // User is authenticated, show dashboard
          showDashboardContent();
          
          // Show profile link
          const profileLink = document.getElementById('viewProfileLink');
          if (profileLink) {
            profileLink.href = `/user-profile.html?id=${currentUser.id}`;
            profileLink.style.display = 'flex';
          }
          
          // Load user profile data
          await loadProfile();
          
          // Load milestones
          await loadMilestones();
          
          // Load sponsor connections
          await loadSponsorConnections();
          
          // Calculate sobriety days
          calculateSobrietyDays();
          
          // Initialize progress visualization
          initializeProgressVisualization();
        } else {
          // User is not authenticated, show sign-in form
          showSignInForm();
        }
      } catch (error) {
        console.error('Failed to initialize dashboard:', error);
        // Show sign-in form on error
        showSignInForm();
      }
    }
    
    function setupEventListeners() {
      // Update sobriety date
      document.getElementById('updateSobrietyDate').addEventListener('click', handleUpdateSobrietyDate);
      
      // Add milestone
      document.getElementById('addMilestoneBtn').addEventListener('click', showAddMilestoneModal);
      
      // Add connection button
      document.getElementById('addConnectionBtn').addEventListener('click', function() {
        window.location.href = '/sponsor-finder.html';
      });
      
      // Sign-in form
      document.getElementById('loginForm').addEventListener('submit', handleSignIn);
      document.getElementById('signUpBtn').addEventListener('click', handleSignUp);
      document.getElementById('forgotPassword').addEventListener('click', handleForgotPassword);
      document.getElementById('googleSignInBtn').addEventListener('click', handleGoogleSignIn);
    }
    
         async function handleUpdateSobrietyDate() {
       try {
         const sobrietyDate = document.getElementById('sobrietyDate').value;
         if (!sobrietyDate) {
           showMessage('Please select a date', 'warning');
           return;
         }
         
         if (!supabase || !currentUser) {
           showMessage('Please log in to update your sobriety date', 'warning');
           return;
         }
         
         console.log('Updating sobriety date for user:', currentUser.id);
         console.log('New sobriety date:', sobrietyDate);
         
         // Update profile in Supabase
         const { error } = await supabase
           .from('profiles_consolidated')
           .upsert({
             user_id: currentUser.id,
             sobriety_date: sobrietyDate
           }, { onConflict: 'user_id' });
         
         if (error) throw error;
         
         console.log('Sobriety date updated successfully');
         showMessage('Sobriety date updated successfully!', 'success');
         calculateSobrietyDays();
       } catch (error) {
         console.error('Failed to update sobriety date:', error);
         showMessage('Failed to update sobriety date', 'danger');
       }
     }
    
         async function loadProfile() {
       try {
         if (!supabase || !currentUser) return;
         
         console.log('Loading profile for user:', currentUser.id);
         
         const { data, error } = await supabase
           .from('profiles_consolidated')
           .select('*')
           .eq('user_id', currentUser.id)
           .single();
         
         if (error && error.code !== 'PGRST116') throw error;
         
         console.log('Profile data loaded:', data);
         console.log('All available fields:', Object.keys(data || {}));
         
         if (data) {
           // Update header with profile display name when available
           if (data.display_name) {
             document.querySelector('.dashboard-hero-title').textContent = `Welcome, ${data.display_name}!`;
           }
           
           // Set sobriety date if available - check multiple possible field names
           if (data.sobriety_date) {
             console.log('Setting sobriety date from sobriety_date field:', data.sobriety_date);
             document.getElementById('sobrietyDate').value = data.sobriety_date;
           } else if (data.sobriety_start_date) {
             console.log('Setting sobriety date from sobriety_start_date field:', data.sobriety_start_date);
             document.getElementById('sobrietyDate').value = data.sobriety_start_date;
           } else if (data.recovery_date) {
             console.log('Setting sobriety date from recovery_date field:', data.recovery_date);
             document.getElementById('sobrietyDate').value = data.recovery_date;
           } else {
             console.log('No sobriety date found in profile data');
             console.log('Available date fields:', {
               sobriety_date: data.sobriety_date,
               sobriety_start_date: data.sobriety_start_date,
               recovery_date: data.recovery_date,
               created_at: data.created_at,
               updated_at: data.updated_at
             });
           }
         } else {
           console.log('No profile data found for user');
         }
       } catch (error) {
         console.error('Failed to load profile:', error);
       }
     }
    
    async function loadMilestones() {
      try {
        if (!supabase || !currentUser) return;
        
        const { data, error } = await supabase
          .from('recovery_milestones')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        displayMilestones(data || []);
      } catch (error) {
        console.error('Failed to load milestones', error);
      }
    }
    
    async function loadSponsorConnections() {
      try {
        if (!supabase || !currentUser) return;
        
        console.log('Loading sponsor connections for user:', currentUser.id);
        
        // Attempt to fetch via server API first
        try {
          const response = await fetch(`/api/sponsor/relationships?user_id=${encodeURIComponent(currentUser.id)}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'x-user-id': currentUser.id
            }
          });
          if (!response.ok) {
            const text = await response.text();
            console.warn('Sponsor relationships API response not ok:', response.status, text);
            throw new Error('api_failed');
          }
          const { relationships } = await response.json();
          console.log('Loaded relationships via API:', relationships);
          displaySponsorConnections(relationships || []);
          return;
        } catch (apiError) {
          console.warn('Falling back to direct Supabase query for relationships:', apiError);
        }

        // Fallback: query Supabase directly (works in static environments)
        const { data: relationships, error: sbError } = await supabase
          .from('sponsor_relationships')
          .select(`
            *,
            sponsor:sponsor_id(
              profiles_consolidated(
                display_name,
                avatar_url
              )
            ),
            sponsee:sponsee_id(
              profiles_consolidated(
                display_name,
                avatar_url
              )
            )
          `)
          .or(`sponsor_id.eq.${currentUser.id},sponsee_id.eq.${currentUser.id}`);

        if (sbError) {
          console.error('Supabase relationships query failed:', sbError);
          throw new Error('Failed to fetch sponsor connections');
        }

        console.log('Loaded relationships via Supabase:', relationships);
        displaySponsorConnections(relationships || []);
      } catch (error) {
        console.error('Failed to load sponsor connections:', error);
        displaySponsorConnections([]);
      }
    }
    
    function displaySponsorConnections(relationships) {
      const connectionsList = document.getElementById('connectionsList');
      const noConnections = document.querySelector('.no-connections');
      const placeholder = document.querySelector('.connection-item.placeholder');
      
      if (!connectionsList) return;
      
      // Hide placeholder
      if (placeholder) {
        placeholder.style.display = 'none';
      }
      
      if (relationships.length === 0) {
        // Show no connections message
        if (noConnections) {
          noConnections.style.display = 'block';
        }
        connectionsList.innerHTML = '';
        return;
      }
      
      // Hide no connections message
      if (noConnections) {
        noConnections.style.display = 'none';
      }
      
      // Display relationships
      connectionsList.innerHTML = relationships.map(relationship => {
        const isSponsor = relationship.sponsor_id === currentUser.id;
        const otherPerson = isSponsor ? relationship.sponsee : relationship.sponsor;
        const relationshipType = isSponsor ? 'Sponsee' : 'Sponsor';
        
        return `
          <div class="connection-item">
            <div class="connection-avatar">
              ${otherPerson?.profiles_consolidated?.avatar_url ? 
                `<img src="${otherPerson.profiles_consolidated.avatar_url}" alt="${otherPerson.profiles_consolidated.display_name}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` :
                `<i class="bi bi-person-circle"></i>`
              }
            </div>
            <div class="connection-info">
              <div class="connection-name">${otherPerson?.profiles_consolidated?.display_name || 'Anonymous'} (${relationshipType})</div>
              <div class="connection-status ${relationship.relationship_status === 'active' ? 'online' : ''}">
                ${relationship.relationship_status === 'active' ? 'Active' : relationship.relationship_status}
              </div>
            </div>
            <div class="connection-actions">
              <button class="btn btn-sm btn-outline-primary" onclick="openChat('${otherPerson.id}')">
                <i class="bi bi-chat-dots me-1"></i>
                Message
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function openChat(userId) {
      // Navigate to chat with specific user
      window.location.href = `/chat?user=${userId}`;
    }
    
    function displayMilestones(milestones) {
      const milestonesList = document.getElementById('milestonesList');
      milestonesList.innerHTML = '';
      
      if (milestones.length === 0) {
        milestonesList.innerHTML = '<p class="text-muted">No milestones yet. Add your first one!</p>';
        return;
      }
      
      milestones.forEach(milestone => {
        const milestoneItem = document.createElement('div');
        milestoneItem.className = 'milestone-item';
        milestoneItem.innerHTML = `
          <div class="milestone-content">
            <h6>${milestone.title}</h6>
            <p>${milestone.description}</p>
            <small class="text-muted">${formatDate(milestone.created_at)}</small>
          </div>
          <div class="milestone-actions">
            <button class="btn btn-sm btn-outline-primary" onclick="editMilestone('${milestone.id}')">Edit</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteMilestone('${milestone.id}')">Delete</button>
          </div>
        `;
        milestonesList.appendChild(milestoneItem);
      });
    }
    
    function showAddMilestoneModal() {
      const title = prompt('Enter milestone title:');
      if (!title) return;
      
      const description = prompt('Enter milestone description:');
      if (!description) return;
      
      addMilestone(title, description);
    }
    
    async function addMilestone(title, description) {
      try {
        if (!supabase || !currentUser) {
          showMessage('Please log in to add milestones', 'warning');
          return;
        }
        
        const { error } = await supabase
          .from('recovery_milestones')
          .insert({
            user_id: currentUser.id,
            title: title,
            description: description,
            created_at: new Date().toISOString()
          });
        
        if (error) throw error;
        
        showMessage('Milestone added successfully!', 'success');
        await loadMilestones();
      } catch (error) {
        console.error('Failed to add milestone:', error);
        showMessage('Failed to add milestone', 'danger');
      }
    }
    
    async function editMilestone(milestoneId) {
      try {
        if (!supabase || !currentUser) return;
        
        const { data, error } = await supabase
          .from('recovery_milestones')
          .select('*')
          .eq('id', milestoneId)
          .eq('user_id', currentUser.id)
          .single();
        
        if (error) throw error;
        
        const newTitle = prompt('Enter new title:', data.title);
        if (!newTitle) return;
        
        const newDescription = prompt('Enter new description:', data.description);
        if (!newDescription) return;
        
        const { error: updateError } = await supabase
          .from('recovery_milestones')
          .update({
            title: newTitle,
            description: newDescription,
            updated_at: new Date().toISOString()
          })
          .eq('id', milestoneId)
          .eq('user_id', currentUser.id);
        
        if (updateError) throw updateError;
        
        showMessage('Milestone updated successfully!', 'success');
        await loadMilestones();
      } catch (error) {
        console.error('Failed to edit milestone:', error);
        showMessage('Failed to edit milestone', 'danger');
      }
    }
    
    async function deleteMilestone(milestoneId) {
      try {
        if (!confirm('Are you sure you want to delete this milestone?')) return;
        
        if (!supabase || !currentUser) return;
        
        const { error } = await supabase
          .from('recovery_milestones')
          .delete()
          .eq('id', milestoneId)
          .eq('user_id', currentUser.id);
        
        if (error) throw error;
        
        showMessage('Milestone deleted successfully!', 'success');
        await loadMilestones();
      } catch (error) {
        console.error('Failed to delete milestone:', error);
        showMessage('Failed to delete milestone', 'danger');
      }
    }
    

    
    function calculateSobrietyDays() {
      const sobrietyDate = document.getElementById('sobrietyDate').value;
      if (!sobrietyDate) {
        document.getElementById('sobrietyDays').textContent = '0';
        updateProgressVisualization();
        return;
      }
      
      const startDate = new Date(sobrietyDate);
      const today = new Date();
      const timeDiff = today.getTime() - startDate.getTime();
      const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
      
      document.getElementById('sobrietyDays').textContent = Math.max(0, daysDiff);
      
      // Update progress visualization
      updateProgressVisualization();
    }
    
    async function updateUserDisplay() {
      if (currentUser) {
        try {
          // Get the user's profile from database to get their custom display_name
          const { data: profile } = await supabase
            .from('profiles_consolidated')
            .select('display_name')
            .eq('user_id', currentUser.id)
            .single();
          
          const displayName = profile?.display_name || 
                             currentUser.user_metadata?.full_name ||
                             currentUser.user_metadata?.display_name ||
                             currentUser.user_metadata?.name ||
                             currentUser.user_metadata?.user_name ||
                             'Get Sober Spokane';
          document.querySelector('.dashboard-hero-title').textContent = `Welcome, ${displayName}!`;
        } catch (error) {
          console.error('Error loading profile for display:', error);
          // Fallback to Google Auth data
          const metaName = currentUser.user_metadata?.full_name ||
                          currentUser.user_metadata?.display_name ||
                          currentUser.user_metadata?.name ||
                          currentUser.user_metadata?.user_name ||
                          'Get Sober Spokane';
          document.querySelector('.dashboard-hero-title').textContent = `Welcome, ${metaName}!`;
        }
      }
    }
    
    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffTime = Math.abs(now - date);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
      if (diffDays < 365) return `${Math.floor(diffDays / 7)} months ago`;
      return date.toLocaleDateString();
    }
    
    // Authentication UI functions
    function showSignInForm() {
      document.getElementById('signInForm').style.display = 'block';
      document.getElementById('dashboardContent').style.display = 'none';
    }
    
    function showDashboardContent() {
      document.getElementById('signInForm').style.display = 'none';
      document.getElementById('dashboardContent').style.display = 'block';
    }
    
    // Sign-in handler
    async function handleSignIn(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email: email,
          password: password
        });
        
        if (error) throw error;
        
        currentUser = data.user;
        showMessage('Successfully signed in!', 'success');
        showDashboardContent();
        
        // Initialize dashboard for authenticated user
        await loadProfile();
        await loadMilestones();
        calculateSobrietyDays();
        
        // Update navigation
        updateNavigation();
        
      } catch (error) {
        console.error('Sign-in error:', error);
        showMessage('Sign-in failed: ' + error.message, 'danger');
      }
    }
    
    // Google Sign-in handler
    async function handleGoogleSignIn(e) {
      e.preventDefault();
      
      try {
        const { data, error } = await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: {
            redirectTo: window.location.origin + window.location.pathname
          }
        });
        
        if (error) throw error;
        
        // The redirect will happen automatically
        showMessage('Redirecting to Google...', 'info');
        
      } catch (error) {
        console.error('Google sign-in error:', error);
        showMessage('Google sign-in failed: ' + error.message, 'danger');
      }
    }
    
    // Sign-up handler
    async function handleSignUp(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      if (password.length < 6) {
        showMessage('Password must be at least 6 characters', 'warning');
        return;
      }
      
      try {
        const { data, error } = await supabase.auth.signUp({
          email: email,
          password: password
        });
        
        if (error) throw error;
        
        showMessage('Account created! Please check your email to verify your account.', 'success');
        
      } catch (error) {
        console.error('Sign-up error:', error);
        showMessage('Sign-up failed: ' + error.message, 'danger');
      }
    }
    
    // Forgot password handler
    async function handleForgotPassword(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      if (!email) {
        showMessage('Please enter your email address', 'warning');
        return;
      }
      
      try {
        const { error } = await supabase.auth.resetPasswordForEmail(email);
        
        if (error) throw error;
        
        showMessage('Password reset email sent! Please check your inbox.', 'success');
        
      } catch (error) {
        console.error('Password reset error:', error);
        showMessage('Password reset failed: ' + error.message, 'danger');
      }
    }
    
    // Update navigation based on auth state
    function updateNavigation() {
      const loginNavItem = document.getElementById('navbarLogin');
      const logoutNavItem = document.getElementById('navbarLogout');
      
      if (currentUser) {
        if (loginNavItem && loginNavItem.parentElement) {
          loginNavItem.parentElement.style.display = 'none';
        }
        if (logoutNavItem && logoutNavItem.parentElement) {
          logoutNavItem.parentElement.style.display = 'block';
        }
        const profileLink = document.getElementById('viewProfileLink');
        if (profileLink) {
          profileLink.href = `/user-profile.html?id=${currentUser.id}`;
          profileLink.style.display = 'flex';
        }
      } else {
        if (loginNavItem && loginNavItem.parentElement) {
          loginNavItem.parentElement.style.display = 'block';
        }
        if (logoutNavItem && logoutNavItem.parentElement) {
          logoutNavItem.parentElement.style.display = 'none';
        }
        const profileLink = document.getElementById('viewProfileLink');
        if (profileLink) profileLink.style.display = 'none';
      }
    }
    
    function showMessage(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      const container = document.querySelector('.dashboard-content .container');
      container.insertBefore(alertDiv, container.firstChild);
      
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 5000);
    }
    
    // Progress Visualization Functions
    function initializeProgressVisualization() {
      createSobrietyProgressRing();
      createAchievementBadges();
      createProgressTimeline();
    }
    
    function createSobrietyProgressRing() {
      const canvas = document.getElementById('sobrietyProgressRing');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = 80;
      
      // Calculate progress percentage (assuming 365 days = 100%)
      const sobrietyDays = parseInt(document.getElementById('sobrietyDays').textContent) || 0;
      const progressPercentage = Math.min((sobrietyDays / 365) * 100, 100);
      
      // Draw background circle
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
      ctx.strokeStyle = '#e9ecef';
      ctx.lineWidth = 12;
      ctx.stroke();
      
      // Draw progress arc
      if (progressPercentage > 0) {
        const startAngle = -Math.PI / 2; // Start from top
        const endAngle = startAngle + (progressPercentage / 100) * 2 * Math.PI;
        
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, startAngle, endAngle);
        ctx.strokeStyle = getProgressColor(progressPercentage);
        ctx.lineWidth = 12;
        ctx.lineCap = 'round';
        ctx.stroke();
      }
      
      // Update overlay text
      document.getElementById('progressRingDays').textContent = sobrietyDays;
    }
    
    function getProgressColor(percentage) {
      if (percentage >= 80) return '#28a745'; // Green for high progress
      if (percentage >= 60) return '#17a2b8'; // Blue for medium-high
      if (percentage >= 40) return '#ffc107'; // Yellow for medium
      if (percentage >= 20) return '#fd7e14'; // Orange for low-medium
      return '#dc3545'; // Red for low progress
    }
    
    function createAchievementBadges() {
      const badgesContainer = document.getElementById('achievementBadges');
      if (!badgesContainer) return;
      
      const sobrietyDays = parseInt(document.getElementById('sobrietyDays').textContent) || 0;
      const badges = [];
      
      // Define achievement milestones
      if (sobrietyDays >= 1) badges.push({ name: 'First Step', icon: 'ðŸŽ¯', color: '#28a745' });
      if (sobrietyDays >= 7) badges.push({ name: 'Week Warrior', icon: 'â­', color: '#17a2b8' });
      if (sobrietyDays >= 30) badges.push({ name: 'Month Master', icon: 'ðŸ†', color: '#ffc107' });
      if (sobrietyDays >= 90) badges.push({ name: 'Quarter Champion', icon: 'ðŸ‘‘', color: '#fd7e14' });
      if (sobrietyDays >= 180) badges.push({ name: 'Halfway Hero', icon: 'ðŸ’Ž', color: '#6f42c1' });
      if (sobrietyDays >= 365) badges.push({ name: 'Year Legend', icon: 'ðŸŒŸ', color: '#e83e8c' });
      
      // Display badges
      badgesContainer.innerHTML = badges.map(badge => `
        <div class="achievement-badge" style="border-color: ${badge.color}">
          <div class="badge-icon" style="color: ${badge.color}">${badge.icon}</div>
          <div class="badge-name">${badge.name}</div>
        </div>
      `).join('');
    }
    
    function createProgressTimeline() {
      const timelineContainer = document.getElementById('progressTimeline');
      if (!timelineContainer) return;
      
      const sobrietyDays = parseInt(document.getElementById('sobrietyDays').textContent) || 0;
      const milestones = [
        { days: 1, title: 'First Day', description: 'The journey begins' },
        { days: 7, title: 'One Week', description: 'Building new habits' },
        { days: 30, title: 'One Month', description: 'Establishing routine' },
        { days: 90, title: 'Three Months', description: 'Strong foundation' },
        { days: 180, title: 'Six Months', description: 'Halfway there' },
        { days: 365, title: 'One Year', description: 'Incredible achievement' }
      ];
      
      const timelineHTML = milestones.map(milestone => {
        const isAchieved = sobrietyDays >= milestone.days;
        const isNext = sobrietyDays < milestone.days && sobrietyDays >= (milestone.days - 30);
        
        return `
          <div class="timeline-item ${isAchieved ? 'achieved' : ''} ${isNext ? 'next' : ''}">
            <div class="timeline-marker">
              <i class="bi ${isAchieved ? 'bi-check-circle-fill' : 'bi-circle'}"></i>
            </div>
            <div class="timeline-content">
              <h6 class="timeline-title">${milestone.title}</h6>
              <p class="timeline-description">${milestone.description}</p>
              <div class="timeline-progress">
                <div class="progress">
                  <div class="progress-bar" style="width: ${Math.min((sobrietyDays / milestone.days) * 100, 100)}%"></div>
                </div>
                <span class="progress-text">${sobrietyDays}/${milestone.days} days</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      timelineContainer.innerHTML = timelineHTML;
    }
    
    // Update progress visualization when sobriety days change
    function updateProgressVisualization() {
      createSobrietyProgressRing();
      createAchievementBadges();
      createProgressTimeline();
    } ild