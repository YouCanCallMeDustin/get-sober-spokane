extends layout

block head
  title= title || 'User Profile - Get Sober Spokane Community'
  meta(name="description" content="View user profiles, sobriety milestones, and community contributions in the Sober Spokane recovery community.")
  meta(name="keywords" content="user profile, sobriety milestones, recovery achievements, community member")

block content
  .profile-container
    // Error Display
    if error
      .container.mt-5
        .alert.alert-danger.text-center
          i.bi.bi-exclamation-triangle.me-2
          = error
    
    // Success Message Display
    if success
      .container.mt-5
        .alert.alert-success.text-center
          i.bi.bi-check-circle.me-2
          = success
    
    // Profile Hero Section
    .profile-hero
      .container
        .row.align-items-center
          .col-lg-8
            .profile-info
              .profile-avatar
                if user && user.avatar
                  img#userAvatar(src=user.avatar alt=`${user.name}'s Avatar`)
                else
                  img#userAvatar(src="/get-sober-spokane/assets/img/default-avatar.png" alt="Default Avatar")
              .profile-details
                h1#userDisplayName= user ? user.name : 'User Profile'
                p#userBio.text-muted= user && user.bio ? user.bio : 'No bio available'
                .profile-stats
                  .stat-item
                    span.stat-number#userPosts= user ? user.posts : 0
                    span.stat-label Posts
                  .stat-item
                    span.stat-number#userComments= user ? user.comments : 0
                    span.stat-label Comments
                  .stat-item
                    span.stat-number#userUpvotes= user ? user.upvotes : 0
                    span.stat-label Upvotes
          
          .col-lg-4.text-lg-end
            .profile-actions
              // Temporarily show edit button for demonstration
              a.btn.btn-outline-primary#editProfileBtn(href=`/user/${user.id}/edit`)
                i.bi.bi-pencil.me-2
                | Edit Profile (Demo)
              
              if currentUser && !isOwnProfile
                button.btn.btn-primary#followUserBtn(type="button")
                  i.bi.bi-person-plus.me-2
                  | Follow
    
    // Profile Content
    .profile-content
      .container
        .row
          // Left Column - Profile Details
          .col-lg-4.mb-4
            .profile-card
              h3.card-title
                i.bi.bi-person-circle.me-2
                | Profile Information
              
              .profile-section
                h5.section-label
                  i.bi.bi-calendar-event.me-2
                  | Sobriety Journey
                .sobriety-info
                  .sobriety-counter
                    span.counter-number#sobrietyDays= user ? user.sobrietyDays : 0
                    span.counter-label days
                  p.counter-subtitle Since last drink or drug use
                  
                  .sobriety-date
                    label Sobriety Date:
                    p#sobrietyDate.text-muted= user && user.sobrietyDate ? new Date(user.sobrietyDate).toLocaleDateString() : 'Not set'
              
              .profile-section
                h5.section-label
                  i.bi.bi-trophy.me-2
                  | Recovery Milestones
                .milestones-list#userMilestones
                  if user && user.milestones && user.milestones.length > 0
                    each milestone in user.milestones
                      .milestone-item
                        span.milestone-icon= milestone.icon
                        span.milestone-name= milestone.name
                        span.milestone-days (#{milestone.days} days)
                  else
                    p.text-muted No milestones yet
              
              .profile-section
                h5.section-label
                  i.bi.bi-geo-alt.me-2
                  | Location
                p#userLocation.text-muted= user && user.location ? user.location : 'Spokane, WA'
              
              .profile-section
                h5.section-label
                  i.bi.bi-calendar.me-2
                  | Member Since
                p#memberSince.text-muted= user && user.memberSince ? new Date(user.memberSince).toLocaleDateString() : 'Loading...'
          
          // Right Column - User Activity
          .col-lg-8.mb-4
            .profile-card
              h3.card-title
                i.bi.bi-activity.me-2
                | Recent Activity
              
              // Activity Tabs
              ul.nav.nav-tabs#activityTabs(role="tablist")
                li.nav-item(role="presentation")
                  button.nav-link.active#posts-tab(data-bs-toggle="tab" data-bs-target="#posts" type="button" role="tab")
                    i.bi.bi-chat-dots.me-2
                    | Posts
                li.nav-item(role="presentation")
                  button.nav-link#comments-tab(data-bs-toggle="tab" data-bs-target="#comments" type="button" role="tab")
                    i.bi.bi-chat.me-2
                    | Comments
                li.nav-item(role="presentation")
                  button.nav-link#achievements-tab(data-bs-toggle="tab" data-bs-target="#achievements" type="button" role="tab")
                    i.bi.bi-award.me-2
                    | Achievements
              
              .tab-content#activityTabContent
                // Posts Tab
                .tab-pane.fade.show.active#posts(role="tabpanel")
                  .activity-list#userPostsList
                    if user && user.recentPosts && user.recentPosts.length > 0
                      each post in user.recentPosts
                        .activity-item
                          .activity-header
                            h6.activity-title= post.title
                            small.text-muted= new Date(post.created_at).toLocaleDateString()
                          .activity-content= post.content.substring(0, 150) + (post.content.length > 150 ? '...' : '')
                          .activity-footer
                            span.badge.bg-primary.me-2 #{post.upvotes || 0} upvotes
                    else
                      .text-center.py-4
                        p.text-muted No posts yet
                
                // Comments Tab
                .tab-pane.fade#comments(role="tabpanel")
                  .activity-list#userCommentsList
                    if user && user.recentComments && user.recentComments.length > 0
                      each comment in user.recentComments
                        .activity-item
                          .activity-content= comment.content.substring(0, 150) + (comment.content.length > 150 ? '...' : '')
                          .activity-footer
                            small.text-muted= new Date(comment.created_at).toLocaleDateString()
                    else
                      .text-center.py-4
                        p.text-muted No comments yet
                
                // Achievements Tab
                .tab-pane.fade#achievements(role="tabpanel")
                  .activity-list#userAchievementsList
                    if user && user.achievements && user.achievements.length > 0
                      each achievement in user.achievements
                        .achievement-item
                          span.achievement-icon= achievement.icon
                          span.achievement-name= achievement.name
                          span.achievement-type.badge.bg-secondary= achievement.type
                    else
                      .text-center.py-4
                        p.text-muted No achievements yet

    // Edit Profile Modal
    #editProfileModal.modal.fade(tabindex="-1")
      .modal-dialog
        .modal-content
          .modal-header
            h5.modal-title
              i.bi.bi-pencil.me-2
              | Edit Profile
            button.btn-close(type="button" data-bs-dismiss="modal")
          .modal-body
            form#editProfileForm(action=`/user/${user.id}/edit` method="POST")
              .mb-3
                label.form-label(for="edit-display-name") Display Name
                input.form-control#edit-display-name(type="text" maxlength="50" value=user ? user.name : '' readonly)
                small.text-muted Display name is managed by Google Auth
              
              .mb-3
                label.form-label(for="edit-bio") Bio
                textarea.form-control#edit-bio(name="bio" rows="3" maxlength="500" placeholder="Tell us about yourself...")= user && user.bio ? user.bio : ''
              
              .mb-3
                label.form-label(for="edit-location") Location
                input.form-control#edit-location(name="location" type="text" maxlength="100" placeholder="City, State" value=user && user.location ? user.location : '')
              
              .mb-3
                label.form-label(for="edit-sobriety-date") Sobriety Date
                input.form-control#edit-sobriety-date(name="sobriety_date" type="date" required value=user && user.sobrietyDate ? user.sobrietyDate : '')
                small.text-muted This is the date you last used alcohol or drugs
              
              .mb-3
                label.form-label(for="edit-privacy") Privacy Settings
                select.form-select#edit-privacy(name="privacy_settings")
                  option(value="public" selected=user && user.privacy_settings === 'public') Public Profile
                  option(value="community" selected=user && user.privacy_settings === 'community') Community Only
                  option(value="private" selected=user && user.privacy_settings === 'private') Private
          
          .modal-footer
            button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
            button.btn.btn-primary#saveProfileBtn(type="submit") Save Changes

block scripts
  script(src="/get-sober-spokane/js/community-forum.js")
  script(src="/get-sober-spokane/js/user-profile.js")
  script.
    // Initialize profile when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Handle follow button functionality
      const followBtn = document.getElementById('followUserBtn');
      if (followBtn) {
        followBtn.addEventListener('click', followUser);
      }
      
      // Handle edit profile modal
      const editProfileBtn = document.getElementById('editProfileBtn');
      if (editProfileBtn) {
        editProfileBtn.addEventListener('click', showEditProfileModal);
      }
      
      // Handle form submission
      const editProfileForm = document.getElementById('editProfileForm');
      if (editProfileForm) {
        editProfileForm.addEventListener('submit', handleProfileUpdate);
      }
    });
    
    function showEditProfileModal() {
      const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
      modal.show();
    }
    
    async function followUser() {
      // Implement follow functionality
      const followBtn = document.getElementById('followUserBtn');
      if (followBtn) {
        followBtn.textContent = 'Following';
        followBtn.classList.remove('btn-primary');
        followBtn.classList.add('btn-outline-primary');
        followBtn.disabled = true;
      }
    }
    
    async function handleProfileUpdate(event) {
      event.preventDefault();
      
      const form = event.target;
      const formData = new FormData(form);
      
      try {
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          // Redirect to profile page with success message
          window.location.href = response.url;
        } else {
          const errorData = await response.json();
          showError(errorData.error || 'Failed to update profile');
        }
      } catch (error) {
        console.error('Error updating profile:', error);
        showError('An error occurred while updating your profile');
      }
    }
    
    function showError(message) {
      // Show error message
      const container = document.querySelector('.profile-content .container');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'alert alert-danger';
      errorDiv.textContent = message;
      container.insertBefore(errorDiv, container.firstChild);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (errorDiv.parentNode) {
          errorDiv.parentNode.removeChild(errorDiv);
        }
      }, 5000);
    }
