extends layout

block head
  title= title || 'User Profile - Get Sober Spokane Community'
  meta(name="description" content="View user profiles, sobriety milestones, and community contributions in the Sober Spokane recovery community.")
  meta(name="keywords" content="user profile, sobriety milestones, recovery achievements, community member")

block content
  .profile-container
    // Error Display
    if error
      .container.mt-5
        .alert.alert-danger.text-center
          i.bi.bi-exclamation-triangle.me-2
          = error
    
    // Success Message Display
    if success
      .container.mt-5
        .alert.alert-success.text-center
          i.bi.bi-check-circle.me-2
          = success
    
    // Profile Hero Section
    .profile-hero
      .container
        .row.align-items-center
          .col-lg-8
            .profile-info
              .profile-avatar
                img#userAvatar(src=user && user.avatar_url ? user.avatar_url : "/assets/img/logo.png" alt="User Avatar")
              .profile-details
                h1#userDisplayName= user ? user.name : 'User Profile'
                .d-flex.align-items-center.mb-2
                  p#userBio.profile-bio.mb-0= user && user.bio ? user.bio : 'No bio available'
                .profile-stats
                  .stat-item
                    span.stat-number#userPosts= user ? user.posts : 0
                    span.stat-label Posts
                  .stat-item
                    span.stat-number#userComments= user ? user.comments : 0
                    span.stat-label Comments
                  .stat-item
                    span.stat-number#userUpvotes= user ? user.upvotes : 0
                    span.stat-label Upvotes
          
          .col-lg-4.text-lg-end
            .profile-actions
              button.btn.btn-primary#editProfileBtn(type="button" style="display: none;")
                i.bi.bi-pencil.me-2
                | Edit Profile
              
              button.btn.btn-primary#followUserBtn(type="button" style="display: none;")
                i.bi.bi-person-plus.me-2
                | Follow
    
    // Profile Content
    .profile-content
      .container
        .row
          // Left Column - Profile Details
          .col-lg-4.mb-4
            .profile-card
              h3.card-title
                i.bi.bi-person-circle.me-2
                | Profile Information
              
              .profile-section
                h5.section-label
                  i.bi.bi-calendar-event.me-2
                  | Sobriety Journey
                .sobriety-info
                  .sobriety-counter
                    span.counter-number#sobrietyDays= user ? user.sobrietyDays : 0
                    span.counter-label days
                  p.counter-subtitle Since last drink or drug use
                  
                  .sobriety-date
                    label Sobriety Date:
                    p#sobrietyDate.text-muted= user && user.sobrietyDate ? new Date(user.sobrietyDate).toLocaleDateString() : 'Not set'
              
              .profile-section
                h5.section-label
                  i.bi.bi-trophy.me-2
                  | Recovery Milestones
                .milestones-list#userMilestones
                  if user && user.milestones && user.milestones.length > 0
                    each milestone in user.milestones
                      .milestone-item
                        span.milestone-icon= milestone.icon
                        span.milestone-name= milestone.name
                        span.milestone-days (#{milestone.days} days)
                  else
                    p.text-muted No milestones yet
              
              .profile-section
                h5.section-label
                  i.bi.bi-geo-alt.me-2
                  | Location
                p#userLocation.text-muted= user && user.location ? user.location : 'Spokane, WA'
              
              .profile-section
                h5.section-label
                  i.bi.bi-calendar.me-2
                  | Member Since
                p#memberSince.text-muted= user && user.memberSince ? new Date(user.memberSince).toLocaleDateString() : 'Loading...'
          
          // Right Column - User Activity
          .col-lg-8.mb-4
            .profile-card
              h3.card-title
                i.bi.bi-activity.me-2
                | Recent Activity
              
              // Activity Tabs
              ul.nav.nav-tabs#activityTabs(role="tablist")
                li.nav-item(role="presentation")
                  button.nav-link.active#posts-tab(data-activity-tab="posts" type="button" role="tab")
                    i.bi.bi-chat-dots.me-2
                    | Posts
                li.nav-item(role="presentation")
                  button.nav-link#comments-tab(data-activity-tab="comments" type="button" role="tab")
                    i.bi.bi-chat.me-2
                    | Comments
                li.nav-item(role="presentation")
                  button.nav-link#achievements-tab(data-activity-tab="achievements" type="button" role="tab")
                    i.bi.bi-award.me-2
                    | Achievements
              
              // Activity Content Container
              #activity-content
                // Posts Tab
                .tab-pane.fade.show.active#posts(role="tabpanel")
                  .activity-list#userPostsList
                    if user && user.recentPosts && user.recentPosts.length > 0
                      each post in user.recentPosts
                        .activity-item
                          .activity-header
                            h6.activity-title= post.title
                            small.text-muted= new Date(post.created_at).toLocaleDateString()
                          .activity-content= post.content.substring(0, 150) + (post.content.length > 150 ? '...' : '')
                          .activity-footer
                            span.badge.bg-primary.me-2 #{post.upvotes || 0} upvotes
                    else
                      .text-center.py-4
                        p.text-muted No posts yet
                
                // Comments Tab
                .tab-pane.fade#comments(role="tabpanel")
                  .activity-list#userCommentsList
                    if user && user.recentComments && user.recentComments.length > 0
                      each comment in user.recentComments
                        .activity-item
                          .activity-content= comment.content.substring(0, 150) + (comment.content.length > 150 ? '...' : '')
                          .activity-footer
                            small.text-muted= new Date(comment.created_at).toLocaleDateString()
                    else
                      .text-center.py-4
                        p.text-muted No comments yet
                
                // Achievements Tab
                .tab-pane.fade#achievements(role="tabpanel")
                  .activity-list#userAchievementsList
                    if user && user.achievements && user.achievements.length > 0
                      each achievement in user.achievements
                        .achievement-item
                          span.achievement-icon= achievement.icon
                          span.achievement-name= achievement.name
                          span.achievement-type.badge.bg-secondary= achievement.type
                    else
                      .text-center.py-4
                        p.text-muted No achievements yet

    // Edit Profile Modal
    #editProfileModal.modal.fade(tabindex="-1")
      .modal-dialog
        .modal-content
          .modal-header
            h5.modal-title
              i.bi.bi-pencil.me-2
              | Edit Profile
            button.btn-close(type="button" data-bs-dismiss="modal")
          .modal-body
            form#editProfileForm(action=`/user/${user ? user.id : 'profile'}/edit` method="POST" enctype="multipart/form-data")
              .mb-3
                label.form-label(for="edit-avatar") Profile Avatar
                .d-flex.align-items-center.mb-2
                  img#currentAvatar.me-3(src=user && user.avatar_url ? user.avatar_url : "/assets/img/logo.png" alt="Current Avatar" style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover;")
                  .flex-grow-1
                    input.form-control#edit-avatar(type="file" name="avatar" accept="image/*")
                    small.text-muted Upload a new profile picture (JPG, PNG, GIF up to 5MB)
              
              .mb-3
                label.form-label(for="edit-display-name") Display Name
                input.form-control#edit-display-name(type="text" name="display_name" maxlength="50" value=user ? user.name : '')
                small.text-muted Choose how you want to be known in the community
              
              .mb-3
                label.form-label(for="edit-bio") Bio
                textarea.form-control#edit-bio(name="bio" rows="3" maxlength="500" placeholder="Tell us about yourself...")= user && user.bio ? user.bio : ''
                small.text-muted.text-end#bioCharCount 500 characters remaining
              
              .mb-3
                label.form-label(for="edit-location") Location
                input.form-control#edit-location(name="location" type="text" maxlength="100" placeholder="City, State" value=user && user.location ? user.location : '')
              
              .mb-3
                label.form-label(for="edit-sobriety-date") Sobriety Date
                input.form-control#edit-sobriety-date(name="sobriety_date" type="date" required value=user && user.sobrietyDate ? user.sobrietyDate : '')
                small.text-muted This is the date you last used alcohol or drugs
              
              .mb-3
                label.form-label(for="edit-privacy") Privacy Settings
                select.form-select#edit-privacy(name="privacy_settings")
                  option(value="public" selected=user && user.privacy_settings === 'public') Public Profile
                  option(value="community" selected=user && user.privacy_settings === 'community') Community Only
                  option(value="private" selected=user && user.privacy_settings === 'private') Private
          
          .modal-footer
            button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
            button.btn.btn-primary#saveProfileBtn(type="submit") Save Changes

block scripts
  script(src="/js/community-forum.js")
  script(src="/js/user-profile.js?v=20250831e")
  script.
    // Initialize profile when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication and show appropriate buttons
      checkAuthAndShowButtons();
      
      // Handle follow button functionality
      const followBtn = document.getElementById('followUserBtn');
      if (followBtn) {
        followBtn.addEventListener('click', followUser);
      }
      
      // Edit profile modal is handled by the Supabase implementation in user-profile.js
      
      // Form submission is handled by the Supabase implementation in user-profile.js
      
      // Setup bio character counter
      setupBioCharCounter();
      
      // Setup avatar preview
      setupAvatarPreview();
    });
    
    async function checkAuthAndShowButtons() {
      try {
        // Check if user is authenticated
        const { data: { user } } = await supabase.auth.getUser();
        
        if (user) {
          // Show edit profile button for authenticated users
          const editBtn = document.getElementById('editProfileBtn');
          if (editBtn) {
            editBtn.style.display = 'inline-block';
          }
          
          // Show follow button for other users' profiles
          const followBtn = document.getElementById('followUserBtn');
          if (followBtn) {
            followBtn.style.display = 'inline-block';
          }
          
          // Populate form with current user data
          populateEditForm(user);
        }
      } catch (error) {
        console.error('Error checking authentication:', error);
      }
    }
    
    function populateEditForm(user) {
      // Populate display name
      const displayNameInput = document.getElementById('edit-display-name');
      if (displayNameInput) {
        displayNameInput.value = user.user_metadata?.full_name || user.email || '';
      }
      
      // Populate bio if available
      const bioInput = document.getElementById('edit-bio');
      if (bioInput) {
        bioInput.value = user.user_metadata?.bio || '';
        updateBioCharCount(); // Update character counter
      }
      
      // Populate location if available
      const locationInput = document.getElementById('edit-location');
      if (locationInput) {
        locationInput.value = user.user_metadata?.location || '';
      }
      
      // Populate sobriety date if available
      const sobrietyInput = document.getElementById('edit-sobriety-date');
      if (sobrietyInput) {
        sobrietyInput.value = user.user_metadata?.sobriety_date || '';
      }
      
      // Populate privacy settings if available
      const privacyInput = document.getElementById('edit-privacy');
      if (privacyInput) {
        privacyInput.value = user.user_metadata?.privacy_settings || 'public';
      }
    }
    
    // Edit profile modal is handled by the Supabase implementation in user-profile.js
    
    function setupBioCharCounter() {
      const bioTextarea = document.getElementById('edit-bio');
      const charCounter = document.getElementById('bioCharCount');
      
      if (bioTextarea && charCounter) {
        bioTextarea.addEventListener('input', updateBioCharCount);
      }
    }
    
    function updateBioCharCount() {
      const bioTextarea = document.getElementById('edit-bio');
      const charCounter = document.getElementById('bioCharCount');
      
      if (bioTextarea && charCounter) {
        const remaining = 500 - bioTextarea.value.length;
        charCounter.textContent = `${remaining} characters remaining`;
        charCounter.className = remaining < 50 ? 'text-danger text-end' : 'text-muted text-end';
      }
    }
    
    function setupAvatarPreview() {
      const avatarInput = document.getElementById('edit-avatar');
      const currentAvatar = document.getElementById('currentAvatar');
      
      if (avatarInput && currentAvatar) {
        avatarInput.addEventListener('change', function(event) {
          const file = event.target.files[0];
          if (file) {
            // Validate file size (5MB limit)
            if (file.size > 5 * 1024 * 1024) {
              alert('File size must be less than 5MB');
              event.target.value = '';
              return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
              alert('Please select an image file');
              event.target.value = '';
              return;
            }
            
            // Preview the image
            const reader = new FileReader();
            reader.onload = function(e) {
              currentAvatar.src = e.target.result;
            };
            reader.readAsDataURL(file);
          }
        });
      }
    }
    
    async function followUser() {
      // Implement follow functionality
      const followBtn = document.getElementById('followUserBtn');
      if (followBtn) {
        followBtn.textContent = 'Following';
        followBtn.classList.remove('btn-primary');
        followBtn.classList.add('btn-outline-primary');
        followBtn.disabled = true;
      }
    }
    
    // Profile update is handled by the Supabase implementation in user-profile.js
    
    // Profile display updates and messaging are handled by the Supabase implementation in user-profile.js
