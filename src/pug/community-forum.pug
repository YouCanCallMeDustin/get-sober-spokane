extends layout

block head
  title Community Forum - Get Sober Spokane
  meta(name="description" content="Connect with the recovery community in Spokane. Share your journey, find support, and celebrate milestones together.")
  meta(name="keywords" content="recovery community, sobriety support, addiction recovery forum, Spokane recovery, sober living support")

block content
  // Forum Container with proper spacing for fixed navigation
  .forum-container
    // Hero Banner Section
    .forum-hero
      .container
        .row.justify-content-center.text-center
          .col-lg-8
            h1.forum-hero-title Community Forum
            p.forum-hero-subtitle Connect, share, and support each other on your recovery journey
    
    // Main Forum Content
    .forum-content
      .container
        // Forum Navigation and Controls
        .forum-controls.mb-4
          .row.align-items-center
            .col-lg-8
              .d-flex.flex-wrap.gap-3.align-items-center
                // Search Bar
                .search-container
                  .input-group
                    .input-group-text
                      i.bi.bi-search
                    input.form-control#forum-search(type="text" placeholder="Search posts, topics, or users...")
                
                // Category Filter
                select.form-select#category-filter(style="min-width: 180px;")
                  option(value="") All Categories
                  option(value="General Discussion") General Discussion
                  option(value="Recovery Support") Recovery Support
                  option(value="Treatment & Resources") Treatment & Resources
                  option(value="Family & Friends") Family & Friends
                  option(value="Mental Health") Mental Health
                  option(value="Employment & Housing") Employment & Housing
                  option(value="Sober Activities") Sober Activities
                  option(value="Success Stories") Success Stories
                
                // Sort Options
                select.form-select#sort-posts(style="min-width: 150px;")
                  option(value="newest") Newest First
                  option(value="oldest") Oldest First
                  option(value="most-voted") Most Voted
                  option(value="most-commented") Most Commented
            
            .col-lg-4.text-lg-end
              button.btn.btn-primary#newPostBtn(type="button")
                i.bi.bi-plus-circle.me-2
                | New Post
        
        // Forum Statistics
        .forum-stats.mb-4
          .row.text-center
            .col-md-3.col-6.mb-3
              .stat-card
                .stat-number#totalPosts 0
                .stat-label Total Posts
            .col-md-3.col-6.mb-3
              .stat-card
                .stat-number#totalUsers 0
                .stat-label Active Users
            .col-md-3.col-6.mb-3
              .stat-card
                .stat-number#totalComments 0
                .stat-label Comments
            .col-md-3.col-6.mb-3
              .stat-card
                .stat-number#successStories 0
                .stat-label Success Stories
        
        // Featured Success Stories
        .featured-stories.mb-4
          h3.section-title
            i.bi.bi-star-fill.text-warning.me-2
            | Featured Success Stories
          .row#featuredStories
            // Featured stories will be loaded dynamically
        
        // Main Posts Container
        .posts-section
          h3.section-title
            i.bi.bi-chat-dots.me-2
            | Community Discussions
          #posts-container
            // Posts will be loaded dynamically
        
        // Load More Button
        .text-center.mt-4
          button.btn.btn-outline-primary#loadMoreBtn(type="button" style="display: none;")
            i.bi.bi-arrow-down.me-2
            | Load More Posts

    // New Post Modal
    #newPostModal.modal.fade(tabindex="-1")
      .modal-dialog.modal-lg
        .modal-content
          .modal-header
            h5.modal-title
              i.bi.bi-plus-circle.me-2
              | Create New Post
            button.btn-close(type="button" data-bs-dismiss="modal")
          .modal-body
            form#newPostForm
              .row
                .col-md-8
                  .mb-3
                    label.form-label(for="post-title") Post Title *
                    input.form-control#post-title(type="text" required maxlength="200" placeholder="What would you like to discuss?")
                
                .col-md-4
                  .mb-3
                    label.form-label(for="post-category") Category *
                    select.form-select#post-category(required)
                      option(value="") Select Category
                      option(value="General Discussion") General Discussion
                      option(value="Recovery Support") Recovery Support
                      option(value="Treatment & Resources") Treatment & Resources
                      option(value="Family & Friends") Family & Friends
                      option(value="Mental Health") Mental Health
                      option(value="Employment & Housing") Employment & Housing
                      option(value="Sober Activities") Sober Activities
                      option(value="Success Stories") Success Stories
              
              .mb-3
                label.form-label(for="post-tags") Tags (optional)
                input.form-control#post-tags(type="text" placeholder="recovery, support, advice, spokane")
                .form-text Separate tags with commas
              
              .mb-3
                label.form-label(for="post-content") Post Content *
                textarea.form-control#post-content(rows="8" required placeholder="Share your thoughts, experiences, questions, or success story...")
                .form-text Minimum 50 characters
              
              .mb-3
                .form-check
                  input.form-check-input#post-anonymous(type="checkbox")
                  label.form-check-label(for="post-anonymous") Post anonymously
                
                .form-check
                  input.form-check-input#post-featured(type="checkbox")
                  label.form-check-label(for="post-featured") Mark as success story (if applicable)
              
              .alert.alert-info
                i.bi.bi-info-circle.me-2
                strong Community Guidelines:
                |  Be supportive, respectful, and mindful of others' privacy. Share experiences rather than medical advice. All posts are moderated.
          
          .modal-footer
            button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
            button.btn.btn-primary#submitPostBtn(type="submit") Create Post

    // Post Detail Modal
    #postDetailModal.modal.fade(tabindex="-1")
      .modal-dialog.modal-xl
        .modal-content
          .modal-header
            h5.modal-title#postDetailTitle
            button.btn-close(type="button" data-bs-dismiss="modal")
          .modal-body
            #postDetailContent
              // Post content and comments will be loaded here
          .modal-footer
            button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Close

block scripts
  script(src="/get-sober-spokane/js/community-forum-enhanced.js")
  script.
    // Initialize forum when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Wire Create Post button to submit the form (button is outside the form)
      const submitBtn = document.getElementById('submitPostBtn');
      const form = document.getElementById('newPostForm');
      if (submitBtn && form) {
        submitBtn.addEventListener('click', function() {
          if (typeof form.requestSubmit === 'function') {
            form.requestSubmit();
          } else {
            form.submit();
          }
        });
      }

      // Check if user is authenticated
      if (window.authManager && window.authManager.isAuthenticated()) {
        // User is logged in, enable full forum features
        initializeAuthenticatedForum();
      } else {
        // User is not logged in, show limited forum view
        initializeGuestForum();
      }
    });
    
    function initializeAuthenticatedForum() {
      console.log('Initializing authenticated forum...');
      // Enable new post creation
      document.getElementById('newPostBtn').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('newPostModal'));
        modal.show();
      });
      
      // Initialize forum with full features
      if (window.forum && typeof window.forum.initializeForum === 'function') {
        window.forum.initializeForum();
      }
    }
    
    function initializeGuestForum() {
      console.log('Initializing guest forum...');
      // Disable new post creation for guests
      document.getElementById('newPostBtn').disabled = true;
      document.getElementById('newPostBtn').title = 'Please sign in to create posts';
      
      // Show limited forum view
      if (window.forum && typeof window.forum.initializeForum === 'function') {
        window.forum.initializeForum();
      }
    }
